<script>
  const urlParams = new URLSearchParams(window.location.search);
  const username = urlParams.get('username');
  const password = urlParams.get('password');

  if (!username || !password) {
    alert("Invalid login! Redirecting to login page...");
    window.location.href = "index.html";
  }

  const socket = io();

  document.getElementById('chat-title').textContent = `Welcome, ${username}!`;

  // 入室メッセージをサーバーに送信
  socket.emit('user join', username);

  document.getElementById('chat-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const message = document.getElementById('message-input').value;

    socket.emit('chat message', { username, message });
    document.getElementById('message-input').value = '';
  });

  socket.on('chat message', (data) => {
    const chatBox = document.getElementById('chat-box');
    const messageElement = document.createElement('div');
    messageElement.className = data.username === username ? 'message self' : 'message';

    // 自分のメッセージではユーザ名を非表示
    if (data.username !== username) {
      const nameElement = document.createElement('div');
      nameElement.className = 'username';
      nameElement.textContent = data.username;
      messageElement.appendChild(nameElement);
    }

    const textElement = document.createElement('div');
    textElement.className = 'text';
    textElement.textContent = data.message;

    messageElement.appendChild(textElement);
    chatBox.appendChild(messageElement);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // 入室メッセージの受信
  socket.on('user join', (username) => {
    const chatBox = document.getElementById('chat-box');
    const joinMessage = document.createElement('div');
    joinMessage.className = 'system-message';
    joinMessage.textContent = `${username} has joined the chat.`;
    chatBox.appendChild(joinMessage);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  // 退室メッセージの受信
  socket.on('user leave', (username) => {
    const chatBox = document.getElementById('chat-box');
    const leaveMessage = document.createElement('div');
    leaveMessage.className = 'system-message';
    leaveMessage.textContent = `${username} has left the chat.`;
    chatBox.appendChild(leaveMessage);
    chatBox.scrollTop = chatBox.scrollHeight;
  });
</script>
